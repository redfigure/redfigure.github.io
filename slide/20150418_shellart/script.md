# あとで書く

---

## 自己紹介

はじめまして

* シェル芸勉強開発参加
* 普段はPythonとたまにRuby
* 全文検索エンジンの運用担当
* シェル芸1年生

---

# 今日のお話

___

## 全文検索エンジンのログ弄り

Groongaって知ってる方いますか？

---

# ここから先の補足情報

___

## DDL

- スキーマはDDLファイルで管理
- 編集はファイルを直接操作
- サービスによっては巨大になりがち

___

## ログ

- プロセスログとクエリログ
- 1つの例外が別々に出力される
- びっくりするほどすぐ肥大化する

---

# シェル芸

___

## git diff からパッチ作るマン

課題

1. 追加するDDLはファイルへ直接追記して保存
2. 差分をとってパッチファイルを作る
3. 人の手による温かみがありすぎる

___

## こう書いた

```
git diff XXXXXX ZZZZZZ | awk 'NF > 0 { if($1 ~ /^\+\+.*/){next} else if($1 ~ /^\+/) print $0 }' | sed 's/^\+//' > patch.ddl
```

___

## 結果

___

## スキーマチェックマン

課題

1. 追加したカラムが多いと確認が辛い
2. 漏れに気づかないとデータ投入で事故る
3. 人の手による温かみが（ｒｙ

___

## こう書いた

```
awk 'NF > 0 { if($1 !~ /^table_create/) system("groonga [DB_PATH] select " $2 " --output_columns " $3 " --limit 0") }' [PATCH_PATH]
```

___

## エラー検知マン

課題

1. クエリログはローテートさせる
2. 実運用だと特にアホほど肥大化する
3. 変なクエリが来てないか楽に確認したい

___

## こう書いた

```
find . -type f -regex .*query-[0-9]+\.log | xargs grep -v "rc=0" | grep "rc=" | wc -l
```

___

## 結果

___

## 犯人探すマン

課題

1. 何らかの要因で殺されることがある
2. 何が刺さって死んでしまったか知りたい
3. 実運用だと障害対応なので早めに情報を出したい

___

## こう書いた

```
cat groonga.log query.log | sort | grep -B 1 "|e|" | grep -A 1 "select?"
```

___

##結果

---

# ありがとうございました
